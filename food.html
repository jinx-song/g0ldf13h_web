<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Food — Goldfish</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,400;0,9..40,500;0,9..40,600;1,9..40,400&family=Fraunces:opsz,wght@9..144,500;9..144,600;9..144,700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="styles.css">
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />
</head>
<body class="food-page">
  <main class="page">
    <header class="page-header">
      <a href="index.html" class="back-link">← Back home</a>
      <h1>Food</h1>
      <p class="lead">Recipes, restaurants, and culinary stories.</p>
    </header>
    <div class="page-content">
      <p>Explore our food section for recipes, restaurant guides, and stories from the table.</p>

      <h2>Goldfish restaurant map</h2>
      <p>This interactive map is populated directly from our shared <a href="https://docs.google.com/spreadsheets/d/1-1samCRAdvP9G9tHhA3aOvJVfPgI6yLpfI6aRMigQzc/edit?gid=0#gid=0" target="_blank" rel="noreferrer">restaurant spreadsheet</a>.</p>

      <div class="map-filters">
        <label>
          <span class="filter-label">Cuisine</span>
          <select id="filter-cuisine" aria-label="Filter by cuisine">
            <option value="">All</option>
          </select>
        </label>
        <label>
          <span class="filter-label">Cuisine type</span>
          <select id="filter-cuisine-type" aria-label="Filter by cuisine type">
            <option value="">All</option>
          </select>
        </label>
        <label>
          <span class="filter-label">Average price</span>
          <select id="filter-price" aria-label="Filter by average price">
            <option value="">All</option>
          </select>
        </label>
      </div>

      <div id="food-map" aria-label="Map of restaurants mentioned in Goldfish spreadsheet"></div>
    </div>
  </main>
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>
  <script>
    (function () {
      const SHEET_CSV_URL =
        "https://docs.google.com/spreadsheets/d/1-1samCRAdvP9G9tHhA3aOvJVfPgI6yLpfI6aRMigQzc/export?format=csv&gid=0";

      const cityCoords = {
        "USA|Seattle": [47.6062, -122.3321],
        "USA|Boston": [42.3601, -71.0589],
        "USA|Milwaukee": [43.0389, -87.9065],
        "USA|Bellevue": [47.6101, -122.2015],
      };

      const map = L.map("food-map", {
        scrollWheelZoom: false,
      }).setView([42.5, -95], 3.5);

      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        maxZoom: 19,
        attribution: "&copy; OpenStreetMap contributors",
      }).addTo(map);

      let allRestaurants = [];
      let markersLayer = L.layerGroup().addTo(map);
      let filterListenersAttached = false;

      function parseCsvLine(line) {
        const out = [];
        let cell = "";
        let inQuotes = false;
        for (let i = 0; i < line.length; i++) {
          const c = line[i];
          if (c === '"') {
            inQuotes = !inQuotes;
          } else if ((c === "," && !inQuotes) || (c === "\r" && !inQuotes)) {
            out.push(cell.trim());
            cell = "";
          } else if (c !== "\r") {
            cell += c;
          }
        }
        out.push(cell.trim());
        return out;
      }

      function parseCsv(csvText) {
        const lines = csvText.trim().split(/\n/);
        const rows = [];
        for (let i = 1; i < lines.length; i++) {
          const cols = parseCsvLine(lines[i]);
          const name = (cols[0] || "").trim();
          if (!name) continue;
          rows.push({
            name,
            country: (cols[1] || "").trim(),
            city: (cols[2] || "").trim(),
            address: (cols[3] || "").trim(),
            cuisine: (cols[4] || "").trim(),
            cuisine_type: (cols[5] || "").trim(),
            average_price: (cols[6] || "").trim(),
          });
        }
        return rows;
      }

      function mergeWithGeocoded(sheetRows, geocodedJson) {
        const byKey = {};
        (geocodedJson || []).forEach((r) => {
          const key = (r.name || "") + "|" + (r.address || r.city || "");
          byKey[key] = r;
        });
        return sheetRows.map((row) => {
          const key1 = (row.name || "") + "|" + (row.address || "");
          const key2 = (row.name || "") + "|" + (row.city || "");
          const cached = byKey[key1] || byKey[key2];
          const cityKey = (row.country || "") + "|" + (row.city || "");
          const fallback = cityCoords[cityKey];
          const lat = cached ? cached.lat : (fallback ? fallback[0] : null);
          const lng = cached ? cached.lng : (fallback ? fallback[1] : null);
          if (lat == null || lng == null) return null;
          return {
            ...row,
            lat,
            lng,
          };
        }).filter(Boolean);
      }

      function uniqueSorted(values) {
        return [...new Set(values)].filter(Boolean).sort((a, b) => String(a).localeCompare(b));
      }

      function fillFilters(restaurants) {
        const selCuisine = document.getElementById("filter-cuisine");
        const selType = document.getElementById("filter-cuisine-type");
        const selPrice = document.getElementById("filter-price");
        selCuisine.innerHTML = '<option value="">All</option>';
        selType.innerHTML = '<option value="">All</option>';
        selPrice.innerHTML = '<option value="">All</option>';
        const cuisines = uniqueSorted(restaurants.map((r) => r.cuisine));
        const types = uniqueSorted(restaurants.map((r) => r.cuisine_type));
        const prices = uniqueSorted(restaurants.map((r) => r.average_price));
        cuisines.forEach((c) => { const o = document.createElement("option"); o.value = c; o.textContent = c; selCuisine.appendChild(o); });
        types.forEach((t) => { const o = document.createElement("option"); o.value = t; o.textContent = t; selType.appendChild(o); });
        prices.forEach((p) => { const o = document.createElement("option"); o.value = p; o.textContent = p; selPrice.appendChild(o); });
      }

      function matchesFilters(r, cuisine, cuisineType, price) {
        if (cuisine && (r.cuisine || "") !== cuisine) return false;
        if (cuisineType && (r.cuisine_type || "") !== cuisineType) return false;
        if (price && (r.average_price || "") !== price) return false;
        return true;
      }

      function popupContent(r) {
        const parts = [r.name];
        if (r.city || r.country) parts.push([r.city, r.country].filter(Boolean).join(", "));
        if (r.address) parts.push(r.address);
        if (r.cuisine) parts.push("Cuisine: " + r.cuisine);
        if (r.cuisine_type) parts.push("Type: " + r.cuisine_type);
        if (r.average_price) parts.push("Price: " + r.average_price);
        return "<strong>" + parts[0] + "</strong><br>" + parts.slice(1).join(" · ");
      }

      function applyFilters() {
        const cuisine = document.getElementById("filter-cuisine").value;
        const cuisineType = document.getElementById("filter-cuisine-type").value;
        const price = document.getElementById("filter-price").value;
        const filtered = allRestaurants.filter((r) => matchesFilters(r, cuisine, cuisineType, price));
        markersLayer.clearLayers();
        const bounds = [];
        filtered.forEach((r) => {
          const marker = L.marker([r.lat, r.lng]).addTo(markersLayer);
          marker.bindPopup(popupContent(r));
          bounds.push([r.lat, r.lng]);
        });
        if (bounds.length) map.fitBounds(bounds, { padding: [32, 32] });
      }

      function onDataReady(restaurants) {
        allRestaurants = restaurants;
        fillFilters(restaurants);
        applyFilters();
        if (!filterListenersAttached) {
          filterListenersAttached = true;
          document.getElementById("filter-cuisine").addEventListener("change", applyFilters);
          document.getElementById("filter-cuisine-type").addEventListener("change", applyFilters);
          document.getElementById("filter-price").addEventListener("change", applyFilters);
        }
      }

      function loadRestaurants() {
        Promise.all([
          fetch(SHEET_CSV_URL).then((r) => r.ok ? r.text() : Promise.reject(new Error("Sheet failed"))),
          fetch("data/restaurants.json").then((r) => r.ok ? r.json() : []).catch(() => []),
        ])
          .then(([csvText, geocoded]) => {
            const sheetRows = parseCsv(csvText);
            const merged = mergeWithGeocoded(sheetRows, geocoded);
            onDataReady(merged);
          })
          .catch((err) => {
            console.error(err);
            fetch("data/restaurants.json")
              .then((r) => r.json())
              .then((json) => onDataReady(json))
              .catch((e) => console.error(e));
          });
      }

      loadRestaurants();
    })();
  </script>
</body>
</html>
